# 06: Analytics Class & Polish

**Priority:** P1
**Depends on:** 01-05
**Complexity:** Medium

---

## Goal
Generate the RudderTyperAnalytics class wrapper, exports, handle edge cases, and ensure everything works together.

---

## 1. RudderTyperAnalytics Class

```typescript
import type {
  RudderAnalytics,
  ApiOptions,
  ApiObject,
  ApiCallback,
} from '@rudderstack/analytics-js';

export class RudderTyperAnalytics {
  private analytics: RudderAnalytics;

  constructor(analytics: RudderAnalytics) {
    this.analytics = analytics;
  }

  // All event methods go here...
  trackSomeEvent(...): void { ... }
  identify(...): void { ... }
  page(...): void { ... }
  group(...): void { ... }
  alias(...): void { ... }

  // Context helper (private)
  private withRudderTyperContext(options: ApiOptions = {}): ApiOptions {
    return {
      ...options,
      context: {
        ...(options.context || {}),
        ruddertyper: {
          sdk: 'analytics.js',
          language: 'typescript',
          rudderTyperVersion: '2.0.0',
          trackingPlanId: 'tp_xxxxx',      // From tracking plan
          trackingPlanVersion: 1,           // From tracking plan
        },
      },
    };
  }
}
```

**Key points:**
- Class-based, NOT global declaration
- Dependency injection via constructor
- Private analytics instance
- Private context helper

---

## 2. Exports

```typescript
// Export the class
export { RudderTyperAnalytics };

// Export all types
export type {
  // Custom Types
  CustomTypeSomeStringType,
  CustomTypeSomeObjectType,
  // Property Types
  PropertySomeString,
  PropertySomeInteger,
  // Event Properties/Traits
  TrackSomeTrackEventProperties,
  IdentifyUserTraits,
  PageProductViewedProperties,
  GroupCompanyTraits,
};
```

---

## 3. Edge Cases

### Special Characters in Names
```yaml
name: 'Product "Premium" Clicked'
```
```typescript
// Method name sanitized, original preserved
trackProductPremiumClicked(...): void {
  this.analytics.track('Product "Premium" Clicked', ...);
}
```

### Name Collisions
When two events sanitize to the same name:
```yaml
- name: "eventName"
- name: "$eventName$!"
```
```typescript
trackEventName(...): void { ... }
trackEventName1(...): void { ... }  // Suffix added
```

### Reserved Words
```yaml
name: "class"
type: "string"
```
```typescript
interface SomeProperties {
  _class?: PropertyClass;  // Prefixed with underscore
}
```

### Empty Objects
```typescript
// With allow_unplanned
type PropertySomeObject = Record<string, any>;

// Strict (no additional properties)
type PropertySomeObject = Record<string, never>;
```

---

## 4. Generated File Structure

Final `index.ts` order:
```typescript
// 1. Header
/**
 * This client was automatically generated by RudderTyper. ** Do Not Edit **
 */

// 2. Imports
import type { RudderAnalytics, ApiOptions, ApiObject, ApiCallback } from '@rudderstack/analytics-js';

// 3. Custom Types
type CustomTypeSomeStringType = string;
interface CustomTypeSomeObjectType { ... }

// 4. Property Types
type PropertySomeString = string;
type PropertySomeInteger = number;

// 5. Event Interfaces
interface TrackSomeEventProperties { ... }
interface IdentifyUserTraits { ... }

// 6. RudderTyperAnalytics Class
export class RudderTyperAnalytics { ... }

// 7. Type Exports
export type { ... };
```

---

## 5. Validation Checklist

### Architecture
- [ ] Class-based with constructor accepting RudderAnalytics
- [ ] No `declare global`
- [ ] Context helper on all calls

### Types
- [ ] Primitives map correctly
- [ ] Required = no `?`, Optional = `?`
- [ ] Enums are union types (not TS enums)
- [ ] Nested objects are inline

### Naming
- [ ] Methods: `track{Name}`, `page{Name}`, `identify`, `group`, `alias`
- [ ] Interfaces: `Track{Name}Properties`, `Identify{Name}Traits`, etc.
- [ ] Reserved words handled
- [ ] Collisions resolved

### Events
- [ ] All event types work
- [ ] Function overloads work
- [ ] Original names preserved

---

## Acceptance Criteria
- [ ] RudderTyperAnalytics class generates correctly
- [ ] Constructor accepts RudderAnalytics instance
- [ ] withRudderTyperContext includes all metadata
- [ ] All types exported
- [ ] Class exported
- [ ] Special characters handled in names
- [ ] Name collisions resolved with suffix
- [ ] Reserved words prefixed with underscore
- [ ] Generated code compiles without errors
- [ ] Generated code passes linting
- [ ] Generated types work with actual RudderStack SDK
